name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  checks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Node install
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Node lint/test/build
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          npm run lint --if-present
          npm test --if-present
          npm run build --if-present

      - name: Setup Python
        if: ${{ hashFiles('**/pyproject.toml', '**/requirements.txt', '**/requirements-dev.txt') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Python install/test
        if: ${{ hashFiles('**/pyproject.toml', '**/requirements.txt', '**/requirements-dev.txt') != '' }}
        run: |
          python -m pip install --upgrade pip
          [ -f requirements.txt ] && pip install -r requirements.txt || true
          [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt || true
          [ -f pyproject.toml ] && pip install . || true
          if [ -d tests ] || [ -d test ]; then pytest -q; fi

      - name: Setup Go
        if: ${{ hashFiles('**/go.mod') != '' }}
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Go test
        if: ${{ hashFiles('**/go.mod') != '' }}
        run: go test ./...

      - name: Setup Rust
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        uses: dtolnay/rust-toolchain@stable

      - name: Rust test
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: cargo test --all --all-features
